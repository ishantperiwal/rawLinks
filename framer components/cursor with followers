import React, { useEffect, useRef } from "react"
import {
    motion,
    useSpring,
    useTime,
    useTransform,
    useMotionValue,
} from "framer-motion"
import { ControlType } from "framer"

/** * GLOBAL CONTROL
 * Higher value = Slower, more "drifting" travel.
 * Lower value = Faster, snappier travel.
 */
const globalSpeedFactor = 2.5

export default function FlowerCursor(props) {
    const {
        flowerImage,
        beeImage,
        size = 50,
        beeSize = 30,
        buzzSpeed = 0.5,
        buzzIntensity = 12,
        bee1OffsetX = -45,
        bee1OffsetY = 45,
        bee2OffsetX = 45,
        bee2OffsetY = 25,
        stiffness = 180,
        damping = 25,
    } = props

    // 1. Core Motion Values
    const mouseX = useMotionValue(0)
    const mouseY = useMotionValue(0)
    const targetB1X = useMotionValue(0)
    const targetB1Y = useMotionValue(0)
    const targetB2X = useMotionValue(0)
    const targetB2Y = useMotionValue(0)

    // 2. The Springs with Global Speed Scaling
    // We divide stiffness by the speed factor squared to lengthen the "period" of the movement
    const scaledStiffness = stiffness / (globalSpeedFactor * globalSpeedFactor)
    const scaledDamping = damping / globalSpeedFactor

    const beeConfig = {
        stiffness: scaledStiffness,
        damping: scaledDamping,
        mass: 1.2,
    }

    const fX = useSpring(mouseX, { stiffness: 1000, damping: 50 })
    const fY = useSpring(mouseY, { stiffness: 1000, damping: 50 })

    const b1X = useSpring(targetB1X, beeConfig)
    const b1Y = useSpring(targetB1Y, beeConfig)
    const b2X = useSpring(targetB2X, beeConfig)
    const b2Y = useSpring(targetB2Y, beeConfig)

    // 3. Velocity Trigger Logic
    const lastPos = useRef({ x: 0, y: 0, t: Date.now() })
    const isHalted = useRef(false)
    const velocityThreshold = 0.6

    useEffect(() => {
        const handleMove = (e: MouseEvent) => {
            const { clientX, clientY } = e
            const now = Date.now()
            const dt = now - lastPos.current.t
            const dx = clientX - lastPos.current.x
            const dy = clientY - lastPos.current.y
            const velocity = Math.sqrt(dx * dx + dy * dy) / (dt || 1)

            mouseX.set(clientX)
            mouseY.set(clientY)

            if (velocity < velocityThreshold) {
                if (!isHalted.current) {
                    targetB1X.set(clientX + bee1OffsetX)
                    targetB1Y.set(clientY + bee1OffsetY)
                    targetB2X.set(clientX + bee2OffsetX)
                    targetB2Y.set(clientY + bee2OffsetY)
                    isHalted.current = true
                }
            } else {
                isHalted.current = false
            }
            lastPos.current = { x: clientX, y: clientY, t: now }
        }

        window.addEventListener("mousemove", handleMove, { passive: true })
        return () => window.removeEventListener("mousemove", handleMove)
    }, [bee1OffsetX, bee1OffsetY, bee2OffsetX, bee2OffsetY])

    // 4. Buzzing Logic
    const time = useTime()
    const b1BuzzX = useTransform(
        time,
        (t: number) => Math.sin(t * 0.005 * buzzSpeed) * buzzIntensity
    )
    const b1BuzzY = useTransform(
        time,
        (t: number) => Math.cos(t * 0.004 * buzzSpeed) * buzzIntensity
    )
    const b2BuzzX = useTransform(
        time,
        (t: number) => Math.cos(t * 0.005 * buzzSpeed) * buzzIntensity
    )
    const b2BuzzY = useTransform(
        time,
        (t: number) => Math.sin(t * 0.006 * buzzSpeed) * buzzIntensity
    )

    const baseStyle: React.CSSProperties = {
        position: "fixed",
        top: 0,
        left: 0,
        width: 0,
        height: 0,
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        pointerEvents: "none",
        zIndex: 9999,
        willChange: "transform",
    }

    return (
        <div style={{ position: "fixed", inset: 0, pointerEvents: "none" }}>
            <motion.div style={{ ...baseStyle, x: fX, y: fY }}>
                <img
                    src={flowerImage}
                    style={{
                        width: size,
                        height: size,
                        transform: "translate(-50%, -50%)",
                    }}
                />
            </motion.div>

            <motion.div style={{ ...baseStyle, x: b1X, y: b1Y }}>
                <motion.div style={{ x: b1BuzzX, y: b1BuzzY }}>
                    <img
                        src={beeImage}
                        style={{
                            width: beeSize,
                            height: beeSize,
                            transform: "translate(-50%, -50%)",
                        }}
                    />
                </motion.div>
            </motion.div>

            <motion.div style={{ ...baseStyle, x: b2X, y: b2Y }}>
                <motion.div style={{ x: b2BuzzX, y: b2BuzzY }}>
                    <img
                        src={beeImage}
                        style={{
                            width: beeSize,
                            height: beeSize,
                            transform: "translate(-50%, -50%)",
                        }}
                    />
                </motion.div>
            </motion.div>
        </div>
    )
}

FlowerCursor.propertyControls = {
    flowerImage: { type: ControlType.Image, title: "Flower" },
    beeImage: { type: ControlType.Image, title: "Bee" },
    size: { type: ControlType.Number, title: "Flower Size", defaultValue: 50 },
    beeSize: { type: ControlType.Number, title: "Bee Size", defaultValue: 30 },
    stiffness: {
        type: ControlType.Number,
        title: "Spring Stiffness",
        defaultValue: 180,
    },
    damping: {
        type: ControlType.Number,
        title: "Spring Damping",
        defaultValue: 25,
    },
    bee1OffsetX: {
        type: ControlType.Number,
        title: "Bee 1 X",
        defaultValue: -45,
    },
    bee1OffsetY: {
        type: ControlType.Number,
        title: "Bee 1 Y",
        defaultValue: 45,
    },
    bee2OffsetX: {
        type: ControlType.Number,
        title: "Bee 2 X",
        defaultValue: 45,
    },
    bee2OffsetY: {
        type: ControlType.Number,
        title: "Bee 2 Y",
        defaultValue: 25,
    },
    buzzSpeed: {
        type: ControlType.Number,
        title: "Buzz Speed",
        defaultValue: 0.5,
        step: 0.1,
    },
    buzzIntensity: {
        type: ControlType.Number,
        title: "Buzz Dist",
        defaultValue: 12,
    },
}
